<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.io Chat</title>
    
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #282c34;
            color: #abb2bf;
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #error-container {
            padding: 20px;
            background-color: #e06c75;
            color: white;
            font-family: monospace;
            font-size: 16px;
            border-radius: 8px;
        }
        #error-container h2 { margin-top: 0; color: white; border-bottom: 1px solid white; }
        .chat-container {
            width: 100%;
            max-width: 600px;
            height: 80vh;
            background-color: #3a3f4a;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        h1 {
            border-bottom: 2px solid #61afef;
            padding: 15px 20px;
            color: white;
            margin: 0;
            text-align: center;
            background-color: #282c34;
        }
        .user-input {
            padding: 10px 20px;
            background-color: #4a505c;
            display: flex;
            align-items: center;
        }
        .user-input input {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid #5c6370;
            border-radius: 4px;
            background-color: #282c34;
            color: #abb2bf;
            font-family: monospace;
        }
        .message-list {
            flex-grow: 1;
            list-style: none;
            padding: 20px;
            margin: 0;
            overflow-y: auto;
        }
        .message-item {
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #282c34;
            border-radius: 8px;
            border-left: 4px solid #61afef;
        }
        .message-item.own-message {
            background-color: #4a505c;
            border-left: 4px solid #98c379;
        }
        .message-user {
            font-weight: bold;
            color: #61afef;
            font-size: 0.9em;
            margin-bottom: 4px;
        }
        .own-message .message-user {
            color: #98c379;
        }
        .message-text {
            color: white;
            word-wrap: break-word;
        }
        .chat-form {
            display: flex;
            padding: 20px;
            background-color: #282c34;
            border-top: 1px solid #5c6370;
        }
        .chat-form input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #5c6370;
            border-radius: 4px 0 0 4px;
            background-color: #3a3f4a;
            color: #abb2bf;
        }
        .chat-form button {
            background-color: #61afef;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        .chat-form button:hover {
            background-color: #528bce;
        }
    </style>
</head>
<body>
    <div id="error-container" style="display: none;">
        <h2>JavaScript Error</h2>
        <p>A required library failed to load. Please check the F12 Developer Console for errors.</p>
        <p>Missing Library: <strong id="missing-lib">Unknown</strong></p>
    </div>
    <noscript>
        <div id="error-container" style="display: block;">
            <h2>JavaScript is Disabled</h2>
            <p>You must enable JavaScript to run this React application.</p>
        </div>
    </noscript>

    <div id="root"></div>

    <script type="text/babel">
        // --- Setup: Make React & Socket.io functions available ---
        const { useState, useEffect, useRef } = React;
        
        // Connect to the Socket.io server
        // Since it's served from the same place, we can just call io()
        const socket = io();

        // --- React Component: Main App ---
        function App() {
            const [username, setUsername] = useState('User' + Math.floor(Math.random() * 1000));
            const [message, setMessage] = useState('');
            const [chat, setChat] = useState([]);
            const messagesEndRef = useRef(null); // Ref to auto-scroll

            // Function to scroll to the bottom of the chat
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            // --- Effect to handle incoming messages ---
            useEffect(() => {
                // Listen for 'chat message' from the server
                socket.on('chat message', (msg) => {
                    // Add new message to the chat state
                    setChat((prevChat) => [...prevChat, msg]);
                });

                // Clean up the listener when the component unmounts
                return () => {
                    socket.off('chat message');
                };
            }, []); // Empty array means this runs only once

            // Effect to scroll when chat state changes
            useEffect(() => {
                scrollToBottom();
            }, [chat]);

            // --- Form Submit Handler ---
            const handleSubmit = (e) => {
                e.preventDefault();
                if (message.trim()) {
                    // Send message to the server
                    const msg = {
                        user: username,
                        text: message
                    };
                    socket.emit('chat message', msg);
                    setMessage(''); // Clear input
                }
            };

            return (
                <div className="chat-container">
                    <h1>Socket.io Chat</h1>
                    
                    <div className="user-input">
                        <label htmlFor="username" style={{marginRight: '10px'}}>Name: </label>
                        <input
                            id="username"
                            type="text"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                        />
                    </div>

                    <ul className="message-list">
                        {chat.map((msg, index) => (
                            <li 
                                key={index} 
                                className={message-item ${msg.user === username ? 'own-message' : ''}}
                            >
                                <div className="message-user">{msg.user}</div>
                                <div className="message-text">{msg.text}</div>
                            </li>
                        ))}
                        {/* Empty div to scroll to */}
                        <div ref={messagesEndRef} />
                    </ul>

                    <form className="chat-form" onSubmit={handleSubmit}>
                        <input
                            type="text"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            placeholder="Type a message..."
                        />
                        <button type="submit">Send</button>
                    </form>
                </div>
            );
        }

        // --- Render the App ---
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <script>
        try {
            let missing = '';
            if (typeof React === 'undefined') missing = 'React';
            else if (typeof ReactDOM === 'undefined') missing = 'ReactDOM';
            else if (typeof Babel === 'undefined') missing = 'Babel';
            else if (typeof io === 'undefined') missing = 'Socket.io Client (io)'; // Check for socket.io

            if (missing) {
                throw new Error(missing + ' is not defined. The CDN script probably failed to load.');
            }
            
            document.getElementById('error-container').style.display = 'none';
            
        } catch (e) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('missing-lib').textContent = e.message;
        }
    </script>
</body>
</html>
